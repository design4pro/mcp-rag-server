name: mcp-rag-acme
services:
  qdrant:
    image: qdrant/qdrant:latest
    container_name: mcp-rag-qdrant-acme
    ports:
      - "6336:6333"
      - "6337:6334"
    volumes:
      - qdrant_data_acme:/qdrant/storage
    environment:
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
    restart: unless-stopped
    healthcheck:
      test:
        ["CMD-SHELL", "timeout 3 bash -c '</dev/tcp/localhost/6333' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s

  mcp-rag-server:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: mcp-rag-server-acme
    ports:
      - "8003:8000"
    environment:
      # Gemini API Configuration
      - MCP_GEMINI_API_KEY=${MCP_GEMINI_API_KEY}
      - MCP_GEMINI_MODEL=${MCP_GEMINI_MODEL:-gemini-2.0-flash-exp}
      - MCP_GEMINI_EMBEDDING_MODEL=${MCP_GEMINI_EMBEDDING_MODEL:-text-embedding-004}
      - MCP_GEMINI_MAX_TOKENS=${MCP_GEMINI_MAX_TOKENS:-4096}
      - MCP_GEMINI_TEMPERATURE=${MCP_GEMINI_TEMPERATURE:-0.3}

      # Qdrant Configuration - Acme Corp Client Project
      - MCP_QDRANT_URL=${MCP_QDRANT_URL:-http://qdrant:6333}
      - MCP_COLLECTION_NAME=${MCP_COLLECTION_NAME:-documents}
      - MCP_COLLECTION=client_acme
      - MCP_VECTOR_SIZE=${MCP_VECTOR_SIZE:-768}
      - MCP_QDRANT_DISTANCE_METRIC=${MCP_QDRANT_DISTANCE_METRIC:-Cosine}

      # Mem0 Configuration - Acme Corp Client Project
      - MCP_MEM0_SELF_HOSTED=${MCP_MEM0_SELF_HOSTED:-true}
      - MCP_MEM0_STORAGE_PATH=${MCP_MEM0_STORAGE_PATH:-/app/mem0_data}
      - MCP_PROJECT_NAMESPACE=acme_corp
      - MCP_USER_ID=acme_team
      - MCP_MEM0_MEMORY_SIZE=${MCP_MEM0_MEMORY_SIZE:-1500}
      - MCP_MEM0_RELEVANCE_THRESHOLD=${MCP_MEM0_RELEVANCE_THRESHOLD:-0.8}
      - MCP_MEM0_MAX_TOKENS_PER_MEMORY=${MCP_MEM0_MAX_TOKENS_PER_MEMORY:-1000}
      - MCP_MEM0_USE_SEMANTIC_SEARCH=${MCP_MEM0_USE_SEMANTIC_SEARCH:-true}
      - MCP_MEM0_SEMANTIC_SEARCH_WEIGHT=${MCP_MEM0_SEMANTIC_SEARCH_WEIGHT:-0.7}
      - MCP_MEM0_KEYWORD_SEARCH_WEIGHT=${MCP_MEM0_KEYWORD_SEARCH_WEIGHT:-0.3}
      - MCP_MEM0_RECENCY_WEIGHT=${MCP_MEM0_RECENCY_WEIGHT:-0.1}
      - MCP_MEM0_MAX_MEMORY_CONTEXT_LENGTH=${MCP_MEM0_MAX_MEMORY_CONTEXT_LENGTH:-2000}
      - MCP_MEM0_ENABLE_MEMORY_SUMMARIZATION=${MCP_MEM0_ENABLE_MEMORY_SUMMARIZATION:-true}

      # MCP Server Configuration - Enhanced Security for Client
      - MCP_SERVER_HOST=${MCP_SERVER_HOST:-0.0.0.0}
      - MCP_SERVER_PORT=${MCP_SERVER_PORT:-8000}
      - MCP_LOG_LEVEL=${MCP_LOG_LEVEL:-DEBUG}
      - MCP_DEBUG=${MCP_DEBUG:-true}
      - MCP_SESSION_TIMEOUT_HOURS=12
      - MCP_MAX_SESSIONS_PER_USER=5
      - MCP_SESSION_CLEANUP_INTERVAL_MINUTES=2
      - MCP_ENABLE_SESSION_TRACKING=true
    volumes:
      - mem0_data_acme:/app/mem0_data
    depends_on:
      qdrant:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test:
        ["CMD", "curl", "-f", "http://localhost:${MCP_SERVER_PORT:-8000}/mcp/"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  qdrant_data_acme:
  mem0_data_acme:
